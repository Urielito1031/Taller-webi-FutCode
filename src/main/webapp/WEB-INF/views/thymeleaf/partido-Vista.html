<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulación de Partido - FutCode</title>
    <link rel="stylesheet" th:href="@{/css/partidoStyle.css}">
</head>
<body>
<div class="container">
    <div class="header">
        <h1> SIMULACIÓN DE PARTIDO</h1>
    </div>

    <div class="match-info">
        <div class="team">
            <div class="team-name" id="team1Name" th:text="${equipoLocal}">River Plate</div>
            <div class="team-score" id="team1Score" th:text="${golesLocal}">0</div>
        </div>
        <div class="vs">VS</div>
        <div class="team">
            <div class="team-name" id="team2Name" th:text="${equipoVisitante}">Boca Juniors</div>
            <div class="team-score" id="team2Score" th:text="${golesVisitante}">0</div>
        </div>
    </div>

    <div class="match-status">
        <div class="time-display" id="matchTime">0'</div>
        <div class="status-indicator playing" id="statusIndicator">EN JUEGO</div>
    </div>

    <div class="controls">
        <button class="btn btn-primary" id="startBtn">INICIAR PARTIDO</button>
        <button class="btn btn-secondary" id="pauseBtn">PAUSAR</button>
        <button class="btn btn-secondary" id="resetBtn">REINICIAR</button>
    </div>

    <div class="stats-section">
        <div class="stat-card">
            <div class="stat-title">Goles Total</div>
            <div class="stat-value" id="totalGoals">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Faltas</div>
            <div class="stat-value" id="totalFouls">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Tarjetas</div>
            <div class="stat-value" id="totalCards">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Lesionados</div>
            <div class="stat-value" id="totalInjuries">0</div>
        </div>
    </div>

    <div class="commentary-section scrollbar">
        <div class="commentary-title">NARRACIÓN EN VIVO</div>
        <div id="commentaryList">
            <div th:each="narracion : ${narraciones}" class="commentary-item" style="display: none;">
                <span class="commentary-minute"></span>
                <span th:text="${narracion.getTexto()}">Aquí va una frase...</span>
            </div>

            <!--            <div th:each="narracion : ${narraciones}"  class="commentary-item">-->
<!--                <span class="commentary-minute">0'</span>-->
<!--                <span th:text="${narracion.getTexto()}">Aquí va una frase...</span>-->
<!--            </div>-->
        </div>
    </div>
    <div id="boton-omitir">
        <button class="btn" id="omitebtn">OMITIR NARRACIÓN</button>
    </div>

    <div class="navigation">
        <a th:href="@{/home}" class="btn btn-home">
            VOLVER AL INICIO
        </a>
    </div>


</div>

<script>
    let currentMinute = 0;
    const maxMinute = 90;

    let golesLocal = 0;
    let golesVisitante = 0;
    let totalFaltas = 0;
    let totalTarjetas = 0;
    let totalLesionados = 0;

    const nombreEquipoLocal = document.getElementById('team1Name').innerText.trim().toLowerCase();
    const nombreEquipoVisitante = document.getElementById('team2Name').innerText.trim().toLowerCase();

    // Función mejorada para detectar eventos específicos
    function detectarEvento(texto) {
        const textoLower = texto.toLowerCase();

        // Detectar GOL - Solo frases que confirmen un gol real
        const patronesGol = [
            /¡{0,2}goo{2,}l/i,           // ¡GOOOOOL, ¡GOOOOL, etc.
            /marca un gol/i,             // "marca un gol"
            /anota para/i,               // "anota para"
            /gol de/i,                   // "gol de"
            /encuentra el gol/i,         // "encuentra el gol"
            /convierte el gol/i,         // "convierte el gol"
            /define.*gol/i               // "define y marca el gol"
        ];

        // Detectar FALTA - Solo faltas confirmadas
        const patronesFalta = [
            /¡{0,2}falta!/i,             // ¡Falta!
            /comete.*falta/i,            // "comete una falta"
            /entrada.*dura/i,            // "entrada dura"
            /juego.*brusco/i,            // "juego brusco"
            /infracción/i,               // "infracción"
            /el árbitro.*falta/i         // "el árbitro marca falta"
        ];

        // Detectar TARJETA - Solo tarjetas mostradas
        const patronesTarjeta = [
            /tarjeta\s+(amarilla|roja)/i, // "tarjeta amarilla" o "tarjeta roja"
            /ve\s+la\s+(amarilla|roja)/i, // "ve la amarilla" o "ve la roja"
            /saca\s+(amarilla|roja)/i,    // "saca amarilla" o "saca roja"
            /cartulina/i,                 // "cartulina"
            /amonesta/i,                  // "amonesta"
            /expuls/i                     // "expulsado", "expulsión"
        ];

        // Detectar LESIÓN - Solo lesiones confirmadas
        const patronesLesion = [
            /lesiona/i,                   // "se lesiona", "lesionado"
            /atención.*médica/i,          // "atención médica"
            /se.*duele/i,                 // "se duele"
            /tendido.*campo/i,            // "tendido en el campo"
            /solicita.*atención/i,        // "solicita atención"
            /debe.*ser.*atendido/i,       // "debe ser atendido"
            /se.*retira.*lesion/i         // "se retira lesionado"
        ];

        // Excluir frases que NO son eventos reales
        const patronesExcluir = [
            /casi/i,                      // "casi gol"
            /cerca.*gol/i,                // "cerca del gol"
            /estuvo.*cerca/i,             // "estuvo cerca"
            /por.*poco/i,                 // "por poco"
            /oportunidad/i,               // "oportunidad perdida"
            /ocasión/i,                   // "ocasión perdida"
            /peligro/i,                   // "llega con peligro"
            /intenta/i,                   // "intenta"
            /busca/i,                     // "busca el gol"
            /podría/i,                    // "podría ser"
            /posible/i                    // "posible"
        ];

        // Primero verificar si debe ser excluido
        for (let patron of patronesExcluir) {
            if (patron.test(textoLower)) {
                return null; // No es un evento real
            }
        }

        // Detectar tipo de evento
        if (patronesGol.some(patron => patron.test(textoLower))) {
            return 'gol';
        }

        if (patronesFalta.some(patron => patron.test(textoLower))) {
            return 'falta';
        }

        if (patronesTarjeta.some(patron => patron.test(textoLower))) {
            return 'tarjeta';
        }

        if (patronesLesion.some(patron => patron.test(textoLower))) {
            return 'lesion';
        }

        return null; // No es un evento reconocido
    }

    // Asignar minutos aleatorios
    document.querySelectorAll('.commentary-item').forEach(item => {
        const randomMinute = Math.floor(Math.random() * 91); // 0-90
        item.setAttribute('data-random-minute', randomMinute);
        item.querySelector('.commentary-minute').innerText = randomMinute + "'";
    });

    // Ordenar por minuto
    function ordenarNarracionesPorMinuto() {
        const lista = document.getElementById('commentaryList');
        const items = Array.from(lista.querySelectorAll('.commentary-item'));

        items.sort((a, b) => {
            return parseInt(a.getAttribute('data-random-minute')) - parseInt(b.getAttribute('data-random-minute'));
        });

        lista.innerHTML = "";
        items.forEach(item => lista.appendChild(item));
    }

    ordenarNarracionesPorMinuto();

    function avanzarTiempo() {
        if (currentMinute > maxMinute) {
            document.getElementById('statusIndicator').innerText = 'FINALIZADO';
            document.getElementById('statusIndicator').style.background = '#ff6b6b';
            clearInterval(intervalo);
            intervalo = null;
            return;
        }

        document.getElementById('matchTime').innerText = currentMinute + "'";

        document.querySelectorAll('.commentary-item').forEach(item => {
            const minuto = parseInt(item.getAttribute('data-random-minute'));
            const yaMostrado = item.style.display === 'block';

            if (minuto === currentMinute && !yaMostrado) {
                item.style.display = 'block';

                // Hacer scroll al comentario más reciente
                item.scrollIntoView({ behavior: 'smooth', block: 'end' });

                const textoCompleto = item.querySelector('span:last-child').innerText;
                const evento = detectarEvento(textoCompleto);

                if (evento) {
                    switch (evento) {
                        case 'gol':
                            // Determinar qué equipo marcó basándose en el texto
                            if (textoCompleto.toLowerCase().includes(nombreEquipoLocal)) {
                                golesLocal++;
                                document.getElementById('team1Score').innerText = golesLocal;
                            } else if (textoCompleto.toLowerCase().includes(nombreEquipoVisitante)) {
                                golesVisitante++;
                                document.getElementById('team2Score').innerText = golesVisitante;
                            }
                            document.getElementById('totalGoals').innerText = golesLocal + golesVisitante;

                            // Efecto visual para gol
                            item.style.borderLeft = '4px solid #ffd700';
                            item.style.background = 'rgba(255, 215, 0, 0.2)';
                            break;

                        case 'falta':
                            totalFaltas++;
                            document.getElementById('totalFouls').innerText = totalFaltas;

                            // Efecto visual para falta
                            item.style.borderLeft = '4px solid #ff9800';
                            item.style.background = 'rgba(255, 152, 0, 0.2)';
                            break;

                        case 'tarjeta':
                            totalTarjetas++;
                            document.getElementById('totalCards').innerText = totalTarjetas;

                            // Efecto visual para tarjeta
                            const esRoja = textoCompleto.toLowerCase().includes('roja');
                            item.style.borderLeft = esRoja ? '4px solid #f44336' : '4px solid #ffeb3b';
                            item.style.background = esRoja ? 'rgba(244, 67, 54, 0.2)' : 'rgba(255, 235, 59, 0.2)';
                            break;

                        case 'lesion':
                            totalLesionados++;
                            document.getElementById('totalInjuries').innerText = totalLesionados;

                            // Efecto visual para lesión
                            item.style.borderLeft = '4px solid #e91e63';
                            item.style.background = 'rgba(233, 30, 99, 0.2)';
                            break;
                    }
                }
            }
        });

        currentMinute++;
    }

    let intervalo = null;

    document.getElementById('startBtn').addEventListener('click', () => {
        if (!intervalo) {
            intervalo = setInterval(avanzarTiempo, 2000); // 2 segundos = 1' partido
            document.getElementById('statusIndicator').innerText = 'EN JUEGO';
            document.getElementById('statusIndicator').style.background = '#00ff88';
        }
    });

    document.getElementById('pauseBtn').addEventListener('click', () => {
        clearInterval(intervalo);
        intervalo = null;
        document.getElementById('statusIndicator').innerText = 'PAUSADO';
        document.getElementById('statusIndicator').style.background = '#ff9800';
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
        clearInterval(intervalo);
        intervalo = null;
        currentMinute = 0;

        golesLocal = 0;
        golesVisitante = 0;
        totalFaltas = 0;
        totalTarjetas = 0;
        totalLesionados = 0;

        document.getElementById('matchTime').innerText = "0'";
        document.getElementById('team1Score').innerText = "0";
        document.getElementById('team2Score').innerText = "0";
        document.getElementById('totalGoals').innerText = "0";
        document.getElementById('totalFouls').innerText = "0";
        document.getElementById('totalCards').innerText = "0";
        document.getElementById('totalInjuries').innerText = "0";

        document.getElementById('statusIndicator').innerText = 'EN JUEGO';
        document.getElementById('statusIndicator').style.background = '#00ff88';

        document.querySelectorAll('.commentary-item').forEach(item => {
            item.style.display = 'none';
            item.style.borderLeft = '4px solid #00ff88';
            item.style.background = 'rgba(255,255,255,0.1)';
        });
    });

    // Función para omitir narración (acelerar tiempo)
    document.getElementById('omitebtn').addEventListener('click', () => {
        if (intervalo) {
            // Acelerar temporalmente
            clearInterval(intervalo);
            intervalo = setInterval(avanzarTiempo, 200); // 0.2 segundos por minuto

            // Volver a velocidad normal después de 10 segundos
            setTimeout(() => {
                if (intervalo) {
                    clearInterval(intervalo);
                    intervalo = setInterval(avanzarTiempo, 2000);
                }
            }, 10000);
        }
    });
</script>

<!--<script>-->
<!--    let currentMinute = 0;-->
<!--    const maxMinute = 90;-->

<!--    let golesLocal = 0;-->
<!--    let golesVisitante = 0;-->
<!--    let totalFaltas = 0;-->
<!--    let totalTarjetas = 0;-->
<!--    let totalLesionados = 0;-->

<!--    const nombreEquipoLocal = document.getElementById('team1Name').innerText.trim().toLowerCase();-->
<!--    const nombreEquipoVisitante = document.getElementById('team2Name').innerText.trim().toLowerCase();-->

<!--    // Asignar minutos aleatorios-->
<!--    document.querySelectorAll('.commentary-item').forEach(item => {-->
<!--        const randomMinute = Math.floor(Math.random() * 91); // 0-90-->
<!--        item.setAttribute('data-random-minute', randomMinute);-->
<!--        item.querySelector('.commentary-minute').innerText = randomMinute + "'";-->
<!--    });-->

<!--    // Ordenar por minuto-->
<!--    function ordenarNarracionesPorMinuto() {-->
<!--        const lista = document.getElementById('commentaryList');-->
<!--        const items = Array.from(lista.querySelectorAll('.commentary-item'));-->

<!--        items.sort((a, b) => {-->
<!--            return parseInt(a.getAttribute('data-random-minute')) - parseInt(b.getAttribute('data-random-minute'));-->
<!--        });-->

<!--        lista.innerHTML = "";-->
<!--        items.forEach(item => lista.appendChild(item));-->
<!--    }-->

<!--    ordenarNarracionesPorMinuto();-->

<!--    function avanzarTiempo() {-->
<!--        if (currentMinute > maxMinute) return;-->

<!--        document.getElementById('matchTime').innerText = currentMinute + "'";-->

<!--        document.querySelectorAll('.commentary-item').forEach(item => {-->
<!--            const minuto = parseInt(item.getAttribute('data-random-minute'));-->
<!--            const yaMostrado = item.style.display === 'block';-->

<!--            if (minuto === currentMinute && !yaMostrado) {-->
<!--                item.style.display = 'block';-->

<!--                const texto = item.innerText.toLowerCase();-->

<!--                // -&#45;&#45; GOL -&#45;&#45;-->
<!--                if (texto.includes("gol")) {-->
<!--                    if (texto.includes(nombreEquipoLocal)) {-->
<!--                        golesLocal++;-->
<!--                        document.getElementById('team1Score').innerText = golesLocal;-->
<!--                    } else if (texto.includes(nombreEquipoVisitante)) {-->
<!--                        golesVisitante++;-->
<!--                        document.getElementById('team2Score').innerText = golesVisitante;-->
<!--                    }-->
<!--                    document.getElementById('totalGoals').innerText = golesLocal + golesVisitante;-->
<!--                }-->

<!--                // -&#45;&#45; FALTA -&#45;&#45;-->
<!--                if (texto.includes("foul") || texto.includes("falta")) {-->
<!--                    totalFaltas++;-->
<!--                    document.getElementById('totalFouls').innerText = totalFaltas;-->
<!--                }-->

<!--                // -&#45;&#45; TARJETAS -&#45;&#45;-->
<!--                if (texto.includes("tarjeta") || texto.includes("amarilla") || texto.includes("roja")) {-->
<!--                    totalTarjetas++;-->
<!--                    document.getElementById('totalCards').innerText = totalTarjetas;-->
<!--                }-->

<!--                // -&#45;&#45; LESIÓN -&#45;&#45;-->
<!--                if (texto.includes("lesionado") || texto.includes("lesión") || texto.includes("se retira lesionado")) {-->
<!--                    totalLesionados++;-->
<!--                    document.getElementById('totalInjuries').innerText = totalLesionados;-->
<!--                }-->
<!--            }-->
<!--        });-->

<!--        currentMinute++;-->
<!--    }-->

<!--    let intervalo = null;-->

<!--    document.getElementById('startBtn').addEventListener('click', () => {-->
<!--        if (!intervalo) {-->
<!--            intervalo = setInterval(avanzarTiempo, 2000); // 2 segundos = 1' partido-->
<!--        }-->
<!--    });-->

<!--    document.getElementById('pauseBtn').addEventListener('click', () => {-->
<!--        clearInterval(intervalo);-->
<!--        intervalo = null;-->
<!--    });-->

<!--    document.getElementById('resetBtn').addEventListener('click', () => {-->
<!--        clearInterval(intervalo);-->
<!--        intervalo = null;-->
<!--        currentMinute = 0;-->

<!--        golesLocal = 0;-->
<!--        golesVisitante = 0;-->
<!--        totalFaltas = 0;-->
<!--        totalTarjetas = 0;-->
<!--        totalLesionados = 0;-->

<!--        document.getElementById('matchTime').innerText = "0'";-->
<!--        document.getElementById('team1Score').innerText = "0";-->
<!--        document.getElementById('team2Score').innerText = "0";-->
<!--        document.getElementById('totalGoals').innerText = "0";-->
<!--        document.getElementById('totalFouls').innerText = "0";-->
<!--        document.getElementById('totalCards').innerText = "0";-->
<!--        document.getElementById('totalInjuries').innerText = "0";-->

<!--        document.querySelectorAll('.commentary-item').forEach(item => {-->
<!--            item.style.display = 'none';-->
<!--        });-->
<!--    });-->
<!--</script>-->



</body>
</html>