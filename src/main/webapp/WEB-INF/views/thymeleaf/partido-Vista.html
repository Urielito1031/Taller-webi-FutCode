<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulación de Partido - FutCode</title>
    <link rel="stylesheet" th:href="@{/css/partidoStyle.css}">
    <style>
    .commentary-item.gol-favor {
        border-left: 6px solid #2ecc40;
        background: #193d1c;
        color: #2ecc40;
        font-weight: bold;
    }
    .commentary-item.gol-contra,
    .commentary-item.expulsion-propia {
        border-left: 6px solid #e74c3c;
        background: #3a1a1a;
        color: #e74c3c;
        font-weight: bold;
    }
    .commentary-item.expulsion-rival {
        border-left: 6px solid #2ecc40;
        background: #193d1c;
        color: #2ecc40;
        font-weight: bold;
    }
    .commentary-item.tarjeta-amarilla {
        border-left: 6px solid #ffe066;
        background: #3a381a;
        color: #ffe066;
        font-weight: bold;
    }
    .commentary-item.tarjeta-roja {
        border-left: 6px solid #e74c3c;
        background: #3a1a1a;
        color: #e74c3c;
        font-weight: bold;
    }
    .commentary-item.lesion {
        border-left: 6px solid #ff8800;
        background: #3a2a1a;
        color: #ff8800;
        font-weight: bold;
    }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1> SIMULACIÓN DE PARTIDO</h1>
    </div>

    <div class="match-info">
        <div class="team">
            <div class="team-name" id="team1Name" th:text="${equipoLocal}">River Plate</div>
            <div class="team-score" id="team1Score">0</div>
        </div>
        <div class="vs">VS</div>
        <div class="team">
            <div class="team-name" id="team2Name" th:text="${equipoVisitante}">Boca Juniors</div>
            <div class="team-score" id="team2Score">0</div>
        </div>
    </div>

    <div class="match-status">
        <div class="time-display" id="matchTime">0'</div>
        <div class="status-indicator playing" id="statusIndicator">EN JUEGO</div>
    </div>

    <div class="controls">
        <button class="btn btn-primary" id="startBtn">INICIAR PARTIDO</button>
        <button class="btn btn-secondary" id="pauseBtn">PAUSAR</button>
        <button class="btn btn-secondary" id="resetBtn">REINICIAR</button>
    </div>

    <div class="stats-section">
        <div class="stat-card">
            <div class="stat-title">Goles Total</div>
            <div class="stat-value" id="totalGoals">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Faltas</div>
            <div class="stat-value" id="totalFouls">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Tarjetas</div>
            <div class="stat-value" id="totalCards">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Lesionados</div>
            <div class="stat-value" id="totalInjuries">0</div>
        </div>
    </div>

    <div class="commentary-section scrollbar">
        <div class="commentary-title">NARRACIÓN EN VIVO</div>
        <div id="commentaryList">
            <div th:each="narracion : ${narraciones}"  class="commentary-item"
                 th:attr="data-minuto=${narracion.minuto},data-tipo=${narracion.tipoEvento}">
                <span class="commentary-minute" th:text="${narracion.minuto} + '\''"></span>
                <span th:text="${narracion.texto}">Aquí va una frase...</span>
            </div>
        </div>
        <input type="hidden" id="equipoUsuario" th:value="${equipoLocal}" />
        <input type="hidden" id="equipoRival" th:value="${equipoVisitante}" />
    </div>
    <div id="boton-omitir">
        <button class="btn" id="omitebtn">OMITIR NARRACIÓN</button>
    </div>

    <div class="navigation">
        <a th:href="@{/home}" class="btn btn-home">
            VOLVER AL INICIO
        </a>
    </div>


</div>
<script>
// Elementos del DOM
const matchTime = document.getElementById("matchTime");
const statusIndicator = document.getElementById("statusIndicator");
const team1Score = document.getElementById("team1Score");
const team2Score = document.getElementById("team2Score");
const totalGoals = document.getElementById("totalGoals");
const totalFouls = document.getElementById("totalFouls");
const totalCards = document.getElementById("totalCards");
const totalInjuries = document.getElementById("totalInjuries");
const commentaryList = document.getElementById("commentaryList");
const startBtn = document.getElementById("startBtn");
const pauseBtn = document.getElementById("pauseBtn");
const resetBtn = document.getElementById("resetBtn");
const omiteBtn = document.getElementById("omitebtn");

// Obtener todas las narraciones enriquecidas
const narraciones = Array.from(commentaryList.querySelectorAll(".commentary-item"))
    .map(item => ({
        minuto: parseInt(item.getAttribute("data-minuto")),
        tipo: item.getAttribute("data-tipo"),
        texto: item.querySelector("span:nth-child(2)").textContent,
        node: item
    }));

narraciones.sort((a, b) => a.minuto - b.minuto);

// Estado
let tiempo = 0;
let partidoEnCurso = false;
let partidoTerminado = false;
let intervalo = null;
let narracionIndex = 0;
let velocidadNarracion = 1000;
let omitirNarracion = false;

let stats = {
    goles: 0,
    faltas: 0,
    tarjetas: 0,
    lesionados: 0
};

// Variables para rastrear goles por equipo
let golesLocal = 0;
let golesVisitante = 0;

function inicializarPartido() {
    commentaryList.innerHTML = '';
    narracionIndex = 0;
    tiempo = 0;
    stats = {goles: 0, faltas: 0, tarjetas: 0, lesionados: 0};
    golesLocal = 0;
    golesVisitante = 0;
    actualizarEstadisticas();
    actualizarMarcador();
    matchTime.textContent = "0'";
    statusIndicator.textContent = "LISTO";
    statusIndicator.className = "status-indicator ready";
    startBtn.disabled = false;
    pauseBtn.disabled = true;
}

function iniciarPartido() {
    if (partidoEnCurso) return;
    partidoEnCurso = true;
    partidoTerminado = false;
    statusIndicator.textContent = "EN JUEGO";
    statusIndicator.className = "status-indicator playing";
    startBtn.disabled = true;
    pauseBtn.disabled = false;
    if (!intervalo) {
        intervalo = setInterval(actualizarTiempo, velocidadNarracion);
    }
}

function pausarPartido() {
    if (!partidoEnCurso) return;
    partidoEnCurso = false;
    statusIndicator.textContent = "PAUSADO";
    statusIndicator.className = "status-indicator paused";
    startBtn.disabled = false;
    pauseBtn.disabled = true;
    clearInterval(intervalo);
    intervalo = null;
}

function reiniciarPartido() {
    clearInterval(intervalo);
    intervalo = null;
    partidoEnCurso = false;
    partidoTerminado = false;
    inicializarPartido();
}

function actualizarTiempo() {
    if (!partidoEnCurso) return;
    tiempo++;
    matchTime.textContent = `${tiempo}'`;
    // Mostrar todas las narraciones de este minuto
    while (narracionIndex < narraciones.length && narraciones[narracionIndex].minuto === tiempo) {
        mostrarNarracion(narraciones[narracionIndex]);
        narracionIndex++;
    }
    // Solo terminar cuando llegue a los 90 minutos
    if (tiempo >= 90) {
        terminarPartido();
    }
}

function mostrarNarracion(narracion) {
    const nuevaNarracion = document.createElement('div');
    nuevaNarracion.className = 'commentary-item';

    // Lógica de color robusta y explícita para goles
    const tipoEvento = narracion.tipo.toLowerCase();
    const textoNarracion = narracion.texto.toLowerCase();

    if (tipoEvento.includes('gol')) {
        if (
            textoNarracion.includes('gol de ' + equipoUsuario) ||
            textoNarracion.includes('goool de ' + equipoUsuario) ||
            textoNarracion.includes('golazo de ' + equipoUsuario) ||
            textoNarracion.includes(equipoUsuario + ' marca')
        ) {
            nuevaNarracion.classList.add('gol-favor');
        } else if (
            textoNarracion.includes('gol de ' + equipoRival) ||
            textoNarracion.includes('goool de ' + equipoRival) ||
            textoNarracion.includes('golazo de ' + equipoRival) ||
            textoNarracion.includes(equipoRival + ' marca')
        ) {
            nuevaNarracion.classList.add('gol-contra');
        } else {
            // Si no se puede determinar, por defecto gol en contra
            nuevaNarracion.classList.add('gol-contra');
        }
    } else if (tipoEvento.includes('expulsion')) {
        if (textoNarracion.includes(equipoUsuario)) {
            nuevaNarracion.classList.add('expulsion-propia');
        } else {
            nuevaNarracion.classList.add('expulsion-rival');
        }
    } else if (tipoEvento.includes('amarilla')) {
        nuevaNarracion.classList.add('tarjeta-amarilla');
    } else if (tipoEvento.includes('roja')) {
        nuevaNarracion.classList.add('tarjeta-roja');
    } else if (tipoEvento.includes('lesion')) {
        nuevaNarracion.classList.add('lesion');
    }

    nuevaNarracion.innerHTML = `<span class="commentary-minute">${narracion.minuto}'</span><span>${narracion.texto}</span>`;
    commentaryList.insertBefore(nuevaNarracion, commentaryList.firstChild);
    nuevaNarracion.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    procesarNarracion(narracion.tipo, narracion.texto);
    actualizarEstadisticas();
}

function procesarNarracion(tipo, texto) {
    switch(tipo) {
        case 'GOL': 
            stats.goles++; 
            // Determinar qué equipo marcó basándose en el texto de la narración
            const equipoLocal = document.getElementById('team1Name').textContent;
            const equipoVisitante = document.getElementById('team2Name').textContent;
            
            if (texto.includes(equipoLocal)) {
                golesLocal++;
            } else if (texto.includes(equipoVisitante)) {
                golesVisitante++;
            } else {
                // Si no se puede determinar, alternar
                if (stats.goles % 2 === 1) {
                    golesLocal++;
                } else {
                    golesVisitante++;
                }
            }
            actualizarMarcador();
            break;
        case 'TARJETA_AMARILLA':
        case 'TARJETA_ROJA':
        case 'EXPULSION': stats.tarjetas++; break;
        case 'LESION': stats.lesionados++; break;
        case 'GENERAL': break;
        default: break;
    }
}

function actualizarMarcador() {
    team1Score.textContent = golesLocal;
    team2Score.textContent = golesVisitante;
}

function actualizarEstadisticas() {
    totalGoals.textContent = stats.goles;
    totalFouls.textContent = stats.faltas;
    totalCards.textContent = stats.tarjetas;
    totalInjuries.textContent = stats.lesionados;
}

function terminarPartido() {
    partidoEnCurso = false;
    partidoTerminado = true;
    clearInterval(intervalo);
    intervalo = null;
    statusIndicator.textContent = "FINALIZADO";
    statusIndicator.className = "status-indicator finished";
    startBtn.disabled = true;
    pauseBtn.disabled = true;
    
    // Asegurar que el tiempo muestre 90' al final
    matchTime.textContent = "90'";
    
    // Mantener el marcador actual (no lo cambiamos)
    // El marcador ya está actualizado con los goles que ocurrieron durante la simulación
    
    const narracionFinal = document.createElement('div');
    narracionFinal.className = 'commentary-item';
    narracionFinal.innerHTML = `<span class="commentary-minute">90'</span><span><strong>¡FINAL DEL PARTIDO!</strong></span>`;
    commentaryList.insertBefore(narracionFinal, commentaryList.firstChild);
    narracionFinal.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    // Festejo si ganaste (local o visitante)
    let golesUsuario = 0, golesRival = 0;
    if (document.getElementById('team1Name').textContent.trim().toLowerCase() === equipoUsuario) {
        golesUsuario = golesLocal;
        golesRival = golesVisitante;
    } else {
        golesUsuario = golesVisitante;
        golesRival = golesLocal;
    }
    if (golesUsuario > golesRival) {
        mostrarFestejoVictoria();
    }
}

function mostrarFestejoVictoria() {
    // Mensaje de victoria
    const victoryMsg = document.createElement('div');
    victoryMsg.textContent = "¡GANASTE EL PARTIDO!";
    victoryMsg.style.position = "fixed";
    victoryMsg.style.top = "35%";
    victoryMsg.style.left = "50%";
    victoryMsg.style.transform = "translate(-50%, -50%)";
    victoryMsg.style.fontSize = "3.5em";
    victoryMsg.style.color = "#2ecc40";
    victoryMsg.style.fontWeight = "bold";
    victoryMsg.style.zIndex = 9999;
    victoryMsg.style.textShadow = "0 0 30px #fff, 0 0 10px #2ecc40";
    victoryMsg.style.background = "rgba(255,255,255,0.8)";
    victoryMsg.style.padding = "30px 60px";
    victoryMsg.style.borderRadius = "20px";
    document.body.appendChild(victoryMsg);

    // Confeti mejorado
    for (let i = 0; i < 60; i++) {
        const confeti = document.createElement('div');
        confeti.style.position = "fixed";
        confeti.style.left = Math.random() * 100 + "vw";
        confeti.style.top = "-40px";
        confeti.style.width = "16px";
        confeti.style.height = "32px";
        confeti.style.background = ["#2ecc40", "#f1c40f", "#e67e22", "#e74c3c", "#3498db", "#9b59b6"][Math.floor(Math.random()*6)];
        confeti.style.borderRadius = "4px";
        confeti.style.opacity = 0.85;
        confeti.style.zIndex = 9999;
        confeti.style.transform = `rotate(${Math.random()*360}deg)`;
        confeti.style.transition = "top 2.2s cubic-bezier(.4,1.4,.7,1)";
        document.body.appendChild(confeti);
        setTimeout(() => {
            confeti.style.top = "100vh";
        }, 10);
        setTimeout(() => {
            confeti.remove();
        }, 2300);
    }
    setTimeout(() => {
        victoryMsg.remove();
    }, 2600);
}

startBtn.addEventListener("click", iniciarPartido);
pauseBtn.addEventListener("click", pausarPartido);
resetBtn.addEventListener("click", reiniciarPartido);

document.addEventListener('DOMContentLoaded', function() {
    inicializarPartido();
});
</script>
</body>
</html>